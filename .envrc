watch_file flake.nix
watch_file flake.lock
mkdir -p "$(direnv_layout_dir)"
eval "$(nix print-dev-env --profile "$(direnv_layout_dir)/flake-profile")"

# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# Use with care or avoid entirely:
# your local envrc based config will not work for others
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[ -e ".envrc-local" ] \
  && echo ".envrc-local config found, sourcing..." \
  && source ".envrc-local"
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

[ "${ADMIN_TOKENS:-false}" = "true" ] && ROLE="admin" || ROLE="developer"

echo "Obtaining and exporting Consul and Nomad $ROLE tokens"
export CONSUL_HTTP_TOKEN="$(vault read -field token consul/creds/${ROLE})"
export NOMAD_TOKEN="$(vault read -field secret_id nomad/creds/${ROLE})"
